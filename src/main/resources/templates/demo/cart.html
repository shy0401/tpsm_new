<!DOCTYPE html>
<html lang="en">
<body>
<th:block th:replace="~{/demo/header :: setContent(~{this::content} )}">
    <th:block th:fragment="content">
<!-- Product section-->
<section class="py-5">
    <div class="container px-4 px-lg-5 my-5">
        <!-- 상품 목록을 위한 반복문 -->
        <div th:id="table" th:each="item: ${cart.savedItems}">
            <!-- 각 상품을 위한 row -->
            <div class="row gx-4 gx-lg-5 align-items-center mb-5">
                <!-- 이미지 섹션 -->
                <div class="col-md-6" style="max-width: 200px;">
                    <img class="card-img-top mb-5 mb-md-0" src="https://dummyimage.com/200x250/dee2e6/6c757d.jpg" alt="..." style="max-width: 100%;" />
                </div>
                <!-- 텍스트와 버튼 섹션 -->
                <div class="col-md-6" style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <div class="small mb-1" style="font-size: 0.8rem;">SKU: BST-498</div>
                    <h1 class="display-6 fw-bolder" style="font-size: 1.5rem;" th:text="${item.post.itemname}"></h1>
                    <div class="fs-5 mb-3">
                        <span class="text-decoration-line-through" style="font-size: 1rem;" th:text="'$' + ${item.post.price * item.quantity}"></span>
                        <span class="price" style="font-size: 1rem;" th:text="'$' + ${item.post.price * item.quantity}" th:data-unit-price="${item.post.price}"></span>
                    </div>
                    <p class="lead" style="font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Praesentium at dolorem quidem modi. Nam sequi consequatur obcaecati excepturi alias magni, accusamus eius blanditiis delectus ipsam minima ea iste laborum vero?
                    </p>
                    <div class="d-flex">
                        <input class="form-control text-center me-3 quantity-input" th:data-item-id="${item.id}" type="number" th:value="${item.quantity}" min="1" style="max-width: 3rem" />
                        <button class="btn deleteCart" type="button" style="background-color: black; color: white; border: none; padding: 0.5rem 1rem; display: flex; align-items: center;">
                            <i class="bi-trash" style="font-size: 1.2rem; margin-right: 0.5rem;"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 총합계를 표시할 영역 -->
        <div class="row gx-4 gx-lg-5 justify-content-end align-items-center">
            <div class="col-md-4 text-end">
                <h2 class="text-end" id="totalPrice"></h2>
            </div>
            <div class="col-md-2 text-end">
                <button id="checkoutButton" class="btn btn-outline-dark d-flex align-items-center justify-content-center" type="button" style="white-space: nowrap;">
                    <i class="bi-credit-card-fill me-2"></i>
                    Checkout
                </button>
            </div>
        </div>
    </div>
</section>
<!-- Footer-->
<footer class="py-5 bg-dark">
    <div class="container"><p class="m-0 text-center text-white">Copyright &copy; Your Website 2023</p></div>
</footer>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
        <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
        <script src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script>
    $(document).ready(function() {
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) { // 캐시된 페이지가 불러와질 때
                window.location.reload(); // 강제로 페이지 리로드
            }
        });

        // 구매 버튼 클릭 시 이벤트 처리
        $("#checkoutButton").click(function () {
            // 현재 총합계를 확인
            const totalPrice = parseFloat($("#totalPrice").text().replace('Total: $', ''));

            // 총합계가 0이면 결제 로직을 실행하지 않음
            if (totalPrice === 0) {
                alert('Your cart is empty. Please add items to your cart before checking out.');
                return; // 함수 종료
            }

            // member의 nickname이 anonymous인지 체크
            const usernickname = "[[${member.nickname}]]";

            if (usernickname === "anonymous") {
                // anonymous이면 /demo/signin 페이지로 이동
                window.location.href = '/demo/signin';
            } else {
                window.location.href = "/demo/purchase";
            }
        });

        // 수량 입력값 변경 시 처리
        $('.quantity-input').on('change', function() {
            const quantity = parseInt($(this).val());
            if (isNaN(quantity) || quantity < 1) {
                alert('Quantity must be 1 or more.');
                $(this).val(1);
                return;
            }

            const itemRow = $(this).closest('.row');
            const priceElement = itemRow.find('.price');
            const unitPrice = parseFloat(priceElement.data('unit-price'));
            const newPrice = (unitPrice * quantity).toFixed(2);
            priceElement.text('$' + newPrice);

            // 총합계를 다시 계산합니다.
            calculateTotalPrice();

            // 서버로 수량 업데이트 요청 전송
            const itemId = $(this).data('item-id');

            $.ajax({
                url: '/demo/updatecart',
                type: 'POST',
                data: { itemId: itemId, quantity: quantity },
                success: function(response) {
                    console.log('Quantity updated successfully!');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', status, error);
                    alert('Failed to update quantity. Please try again.');
                }
            });
        });

        // 삭제 버튼 클릭 시 처리
        $('.deleteCart').click(function () {
            const itemRow = $(this).closest('.row');
            const itemId = itemRow.find('.quantity-input').data('item-id');

            $.ajax({
                url: '/demo/deletecart',
                type: 'POST',
                data: { itemId: itemId },
                success: function(response) {
                    alert('Item deleted successfully!');
                    // 아이템 행을 뷰에서 제거
                    itemRow.remove();
                    window.location.reload();

                    // 총합계 다시 계산
                    calculateTotalPrice();
                },
                error: function(xhr, status, error) {
                    console.error('Error:', status, error);
                    alert('Failed to delete item. Please try again.');
                }
            });
        });

        // 총합계 계산 함수
        function calculateTotalPrice() {
            let totalPrice = 0;

            $('.price').each(function() {
                const price = parseFloat($(this).text().replace('$', ''));
                if (!isNaN(price)) {
                    totalPrice += price;
                }
            });

            $("#totalPrice").text("Total: $" + totalPrice.toFixed(2));
        }

        // 페이지 로드 시 총합계 계산
        calculateTotalPrice();
    });

    function requestPay() {
        IMP.init('imp84615760'); //iamport 대신 자신의 "가맹점 식별코드"를 사용
        IMP.request_pay({
            pg: "settle.portone1",
            pay_method: "card",
            merchant_uid : 'kakaotest'+new Date().getTime(),
            name : '결제테스트',
            amount : 1000,
            buyer_email : 'iamport@siot.do',
            buyer_name : '구매자',
            buyer_tel : '010-1234-5678',
            buyer_addr : '서울특별시 강남구 삼성동',
            buyer_postcode : '123-456'
        }, function (rsp) {
            console.log(rsp);
            if (rsp.success) {
                var msg = '결제가 완료되었습니다.';
                alert(msg);
                window.location.reload();
            } else {
                var msg = '결제에 실패하였습니다.';
                msg += '에러내용 : ' + rsp.error_msg;
                alert(msg);
            }
        });
    }
</script>
    </th:block>
</th:block>
</body>
</html>